{% extends 'base.html' %}
{% load static %}

{% block title %}{{ surah.name_arabic }} - سورة {{ surah.name_arabic }}{% endblock %}

{% block extra_css %}
<style>
    /* Quran text styling */
    .quran-container {
        font-family: 'Amiri', 'Traditional Arabic', serif;
        direction: rtl;
        text-align: right;
        line-height: 2.2;
        padding: 20px;
        background-color: {% if reading_settings.night_mode %}#1a1a1a{% else %}#f8f9fa{% endif %};
        color: {% if reading_settings.night_mode %}#e0e0e0{% else %}#333{% endif %};
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .quran-text {
        font-size: {% if reading_settings.font_size %}{{ reading_settings.font_size }}px{% else %}24px{% endif %};
        font-family: {% if reading_settings.font_family %}{{ reading_settings.font_family }}{% else %}'Amiri'{% endif %}, 'Traditional Arabic', serif;
    }

    .ayah-container {
        margin-bottom: 10px;
        position: relative;
    }

    .ayah-text {
        display: inline;
    }

    .ayah-number {
        font-family: 'Amiri', serif;
        font-size: 0.7em;
        color: {% if reading_settings.night_mode %}#aaa{% else %}#777{% endif %};
        margin: 0 5px;
        display: none;
    }

    .ayah-actions {
        display: none;
        position: absolute;
        left: 0;
        top: 0;
        background-color: {% if reading_settings.night_mode %}#333{% else %}#fff{% endif %};
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        padding: 5px;
        z-index: 10;
    }

    .ayah-container:hover .ayah-actions {
        display: block;
    }

    .ayah-actions a {
        margin: 0 5px;
        color: {% if reading_settings.night_mode %}#e0e0e0{% else %}#333{% endif %};
        text-decoration: none;
    }

    .ayah-actions a:hover {
        color: #007bff;
    }

    .surah-info {
        background-color: {% if reading_settings.night_mode %}#2a2a2a{% else %}#fff{% endif %};
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .surah-header {
        text-align: center;
        margin-bottom: 20px;
    }

    .surah-name-arabic {
        font-family: 'Amiri', 'Traditional Arabic', serif;
        font-size: 2.5rem;
        margin-bottom: 5px;
    }

    .surah-name-english {
        font-size: 1.2rem;
        color: {% if reading_settings.night_mode %}#aaa{% else %}#777{% endif %};
    }

    .surah-meta {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
    }

    .surah-meta-item {
        text-align: center;
    }

    .surah-meta-value {
        font-size: 1.2rem;
        font-weight: bold;
    }

    .surah-meta-label {
        font-size: 0.9rem;
        color: {% if reading_settings.night_mode %}#aaa{% else %}#777{% endif %};
    }

    .bismillah {
        text-align: center;
        font-family: 'Amiri', 'Traditional Arabic', serif;
        font-size: 1.8rem;
        margin-bottom: 20px;
    }

    .audio-player {
        margin-bottom: 20px;
    }

    .translation-text {
        font-size: 1rem;
        color: {% if reading_settings.night_mode %}#bbb{% else %}#555{% endif %};
        margin-top: 5px;
        font-style: italic;
    }

    .navigation-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .quran-text {
            font-size: {% if reading_settings.font_size %}{{ reading_settings.font_size|add:"-4" }}px{% else %}20px{% endif %};
        }

        .surah-name-arabic {
            font-size: 2rem;
        }

        .surah-meta {
            flex-wrap: wrap;
        }

        .surah-meta-item {
            width: 50%;
            margin-bottom: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'core:index' %}">الرئيسية</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'quran:surah_list' %}">القرآن الكريم</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ surah.name_arabic }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Surah Information -->
            <div class="surah-info">
                <div class="surah-header">
                    <h1 class="surah-name-arabic">{{ surah.name_arabic }}</h1>
                    <div class="surah-name-english">{{ surah.name_english }}</div>
                </div>

                <div class="surah-meta">
                    <div class="surah-meta-item">
                        <div class="surah-meta-value">{{ surah.surah_number }}</div>
                        <div class="surah-meta-label">رقم السورة</div>
                    </div>
                    <div class="surah-meta-item">
                        <div class="surah-meta-value">{{ surah.verses_count }}</div>
                        <div class="surah-meta-label">عدد الآيات</div>
                    </div>
                    <div class="surah-meta-item">
                        <div class="surah-meta-value">{{ surah.get_revelation_type_display }}</div>
                        <div class="surah-meta-label">نوع السورة</div>
                    </div>
                    <div class="surah-meta-item">
                        <div class="surah-meta-value">{{ surah.revelation_order|default:"-" }}</div>
                        <div class="surah-meta-label">ترتيب النزول</div>
                    </div>
                </div>

                {% if surah.surah_number != 1 and surah.surah_number != 9 %}
                <div class="bismillah">بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ</div>
                {% endif %}
            </div>

            <!-- Audio Player -->
            <div class="audio-player">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">استمع إلى السورة</h5>
                        <select class="form-select mb-3" id="reciterSelect">
                            <option value="">اختر القارئ</option>
                            {% for reciter in reciters %}
                            <option value="{{ reciter.id }}">{{ reciter.name_arabic }}</option>
                            {% endfor %}
                        </select>
                        <audio controls class="w-100" id="audioPlayer">
                            <source src="" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                </div>
            </div>

            <!-- Quran Text -->
            <div class="quran-container">
                {% for ayah in ayahs %}
                <div class="ayah-container" id="ayah-{{ ayah.ayah_number_in_surah }}">
                    <span class="ayah-text">{{ ayah.text_uthmani }}</span>
                    <span class="ayah-number">﴿{{ ayah.ayah_number_in_surah }}﴾</span>

                    <div class="ayah-actions">
                        <a href="{% url 'quran:bookmark_ayah' surah_number=surah.surah_number ayah_number=ayah.ayah_number_in_surah %}" title="إضافة إشارة مرجعية">
                            <i class="bi bi-bookmark-plus"></i>
                        </a>
                        <a href="#" class="copy-ayah" data-ayah-text="{{ ayah.text_uthmani }}" title="نسخ الآية">
                            <i class="bi bi-clipboard"></i>
                        </a>
                        <a href="#" class="share-ayah" data-ayah-text="{{ ayah.text_uthmani }}" data-surah-name="{{ surah.name_arabic }}" data-ayah-number="{{ ayah.ayah_number_in_surah }}" title="مشاركة الآية">
                            <i class="bi bi-share"></i>
                        </a>
                    </div>

                    {% if reading_settings.show_translation and ayah.translation %}
                    <div class="translation-text">{{ ayah.translation }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <!-- Navigation Buttons -->
            <div class="navigation-buttons">
                {% if previous_surah %}
                <a href="{% url 'quran:surah_detail' surah_number=previous_surah.surah_number %}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-right me-1"></i> {{ previous_surah.name_arabic }}
                </a>
                {% else %}
                <div></div>
                {% endif %}

                {% if next_surah %}
                <a href="{% url 'quran:surah_detail' surah_number=next_surah.surah_number %}" class="btn btn-outline-primary">
                    {{ next_surah.name_arabic }} <i class="bi bi-arrow-left ms-1"></i>
                </a>
                {% else %}
                <div></div>
                {% endif %}
            </div>
        </div>

        <div class="col-md-4">
            <!-- Sidebar with reading settings and other options -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">إعدادات القراءة</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="fontSizeRange" class="form-label">حجم الخط</label>
                        <input type="range" class="form-range" min="16" max="36" step="2" id="fontSizeRange" value="{% if reading_settings.font_size %}{{ reading_settings.font_size }}{% else %}24{% endif %}">
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="nightModeSwitch" {% if reading_settings.night_mode %}checked{% endif %}>
                            <label class="form-check-label" for="nightModeSwitch">الوضع الليلي</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="showTranslationSwitch" {% if reading_settings.show_translation %}checked{% endif %}>
                            <label class="form-check-label" for="showTranslationSwitch">عرض الترجمة</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="showAyahNumbersSwitch">
                            <label class="form-check-label" for="showAyahNumbersSwitch">عرض أرقام الآيات</label>
                        </div>
                    </div>

                    <a href="{% url 'quran:reading_settings' %}" class="btn btn-outline-primary w-100">
                        <i class="bi bi-gear me-1"></i> المزيد من الإعدادات
                    </a>
                </div>
            </div>

            <!-- Surah List -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">سور القرآن الكريم</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for i in "123456789"|make_list %}
                        <a href="{% url 'quran:surah_detail' surah_number=forloop.counter %}" class="list-group-item list-group-item-action {% if surah.surah_number == forloop.counter %}active{% endif %}">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>{{ forloop.counter }}. {{ surah.name_arabic }}</span>
                                <span class="badge bg-secondary">{{ surah.verses_count }} آية</span>
                            </div>
                        </a>
                        {% endfor %}
                        <a href="{% url 'quran:surah_list' %}" class="list-group-item list-group-item-action text-center">
                            <i class="bi bi-three-dots me-1"></i> عرض كل السور
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Font size adjustment
        $('#fontSizeRange').on('input', function() {
            const fontSize = $(this).val();
            $('.quran-text').css('font-size', fontSize + 'px');
        });

        // Night mode toggle
        $('#nightModeSwitch').change(function() {
            const isNightMode = $(this).is(':checked');
            if (isNightMode) {
                $('.quran-container').css({
                    'background-color': '#1a1a1a',
                    'color': '#e0e0e0'
                });
                $('.surah-info').css('background-color', '#2a2a2a');
                $('.ayah-number').css('color', '#aaa');
                $('.translation-text').css('color', '#bbb');
                $('.surah-name-english, .surah-meta-label').css('color', '#aaa');
            } else {
                $('.quran-container').css({
                    'background-color': '#f8f9fa',
                    'color': '#333'
                });
                $('.surah-info').css('background-color', '#fff');
                $('.ayah-number').css('color', '#777');
                $('.translation-text').css('color', '#555');
                $('.surah-name-english, .surah-meta-label').css('color', '#777');
            }
        });

        // Show/hide translation
        $('#showTranslationSwitch').change(function() {
            const showTranslation = $(this).is(':checked');
            if (showTranslation) {
                $('.translation-text').show();
            } else {
                $('.translation-text').hide();
            }
        });

        // Show/hide ayah numbers
        $('#showAyahNumbersSwitch').change(function() {
            const showAyahNumbers = $(this).is(':checked');
            if (showAyahNumbers) {
                $('.ayah-number').show();
            } else {
                $('.ayah-number').hide();
            }
        });

        // Reciter selection
        $('#reciterSelect').change(function() {
            const reciterId = $(this).val();
            if (reciterId) {
                const audioUrl = `/media/recitations/${reciterId}/{{ surah.surah_number }}.mp3`;
                $('#audioPlayer').attr('src', audioUrl);
                $('#audioPlayer')[0].load();
            }
        });

        // Copy ayah text
        $('.copy-ayah').click(function(e) {
            e.preventDefault();
            const ayahText = $(this).data('ayah-text');
            navigator.clipboard.writeText(ayahText).then(function() {
                alert('تم نسخ الآية بنجاح');
            }, function() {
                alert('فشل نسخ الآية');
            });
        });

        // Share ayah
        $('.share-ayah').click(function(e) {
            e.preventDefault();
            const ayahText = $(this).data('ayah-text');
            const surahName = $(this).data('surah-name');
            const ayahNumber = $(this).data('ayah-number');
            const shareText = `${ayahText} [${surahName}: ${ayahNumber}]`;

            if (navigator.share) {
                navigator.share({
                    title: `${surahName} - الآية ${ayahNumber}`,
                    text: shareText,
                    url: window.location.href + '#ayah-' + ayahNumber
                }).then(() => {
                    console.log('Share successful');
                }).catch((error) => {
                    console.log('Error sharing', error);
                });
            } else {
                navigator.clipboard.writeText(shareText).then(function() {
                    alert('تم نسخ الآية للمشاركة بنجاح');
                }, function() {
                    alert('فشل نسخ الآية للمشاركة');
                });
            }
        });
    });
</script>
{% endblock %}
